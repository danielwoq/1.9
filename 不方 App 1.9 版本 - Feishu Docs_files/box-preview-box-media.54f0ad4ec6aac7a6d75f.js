(this.webpackJsonp=this.webpackJsonp||[]).push([["box-preview-box-media"],{L8cP:function(e,t,n){"use strict";n.d(t,"a",function(){return v}),n.d(t,"b",function(){return h});var r=n("IzLi"),i=n("WxoT"),s=n.n(i),o=n("/FZm"),a=n.n(o),l=n("Wz9t"),c=n("TEMH"),u=n.n(c);function d(e){if(!localStorage.hasOwnProperty(e))return 0;var t=2*((localStorage[e].length||0)+e.length);return Number((t/1024).toFixed(2))}function p(e){return!(!Object(r.a)(e)||!e.token)&&(!!e.time||(1<e.pageIndex||0<e.tabIndex))}function f(e){try{var t=localStorage.getItem(e)||"[]";return JSON.parse(t)}catch(e){return console.error(e),[]}}function h(e){var t=e.key,n=e.info;try{d(t)>l.J&&localStorage.removeItem(t);var r=n.token,i=n.version,o=f(t),a=u()(o).call(o,function(e){return i?e.token===r&&e.version===i:e.token===r});-1!==a?o[a]=n:p(n)&&o.push(n),localStorage.setItem(t,s()(o))}catch(e){console.error(e)}}function v(e){var t=e.key,n=e.fileToken,r=e.dataVersion,i=f(t);return a()(i).call(i,function(e){return r?e.token===n&&e.version===r:e.token===n})}},QsyW:function(e,t,n){"use strict";n.r(t);var r=n("526F"),y=n.n(r),i=n("q1tI"),g=n.n(i),o=n("LYCE"),a=n.n(o),s=n("HnXd"),l=n.n(s),c=n("qjzJ"),u=n.n(c),d=n("RXMP"),p=n.n(d),f=n("fHi0"),h=n.n(f),v=n("5PDf"),m=n.n(v),w=n("OWCx"),T=n.n(w),b=n("+oHS"),x=n.n(b),E=n("04Ix"),k=n.n(E),R=n("06Pm"),C=n.n(R),P=n("kA7L"),M=n.n(P),S=n("3SUL"),I=n.n(S),O=n("eYnF"),_=n.n(O),V=n("X5/F"),D=n.n(V),F=n("q7cj"),U=n("mnMc"),L=n.n(U),N=n("a0dU"),j=n.n(N),B=n("SPx3"),W=n.n(B),H=n("MAKL"),z=n.n(H),Y=n("o+MX"),K=n.n(Y),X=n("FLGM"),J=n.n(X),q=n("yIs4"),Z=n("zmn3"),Q=n("7EGn"),$=n("WxoT"),ee=n.n($),te=(n("/FZm"),n("Vi3r")),ne=n.n(te),re=n("BmhO"),ie=n("Wz9t"),oe=n("UF4K"),ae=n.n(oe),se=n("S/x3"),le=n("EbbD"),ce=(n("TEMH"),n("L8cP")),ue=n("YdDX"),de=n.n(ue),pe=n("vOnD"),fe=n("Ngi8"),he=n("Zz/9");function ve(){var e=de()(["\n  color: ",";\n  font-size: 14px;\n  user-select: none;\n"]);return ve=function(){return e},e}function me(){var e=de()(["\n  width: 100%;\n  height: 100%;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  background: ",";\n"]);return me=function(){return e},e}function ye(){var e=de()(["\n  user-select: none;\n  cursor: pointer;\n  position: absolute;\n  top: 2px;\n  right: 3px;\n"]);return ye=function(){return e},e}function ge(){var e=de()(["\n  margin-left: 10px;\n  min-width: 90px;\n  text-align: left;\n"]);return ge=function(){return e},e}function we(){var e=de()(["\n  font-weight: bold;\n  min-width: 110px;\n  text-align: right;\n"]);return we=function(){return e},e}function Te(){var e=de()(["\n  display: flex;\n  justify-content: center;\n"]);return Te=function(){return e},e}function be(){var e=de()(["\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  color: ",";\n  background: ",";\n  z-index: ",";\n  font-size: 12px;\n  display: flex;\n  justify-content: space-between;\n  padding: 2px 6px;\n  border-radius: 4px;\n  min-width: 100px;\n  flex-direction: column;\n"]);return be=function(){return e},e}function xe(){var e=de()(["\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n  width: 100%;\n  height: 100%;\n  max-height: calc(100vh - 160px);\n\n  &:hover {\n    "," {\n      display: block;\n    }\n  }\n\n  ","\n"]);return xe=function(){return e},e}function Ee(){var e=de()(["\n  display: ",";\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 60px;\n  font-size: 14px;\n  line-height: 22px;\n  color: ",";\n  padding: 12px 0 26px 16px;\n  border-radius: 4px;\n  background: linear-gradient(\n    180deg,\n    "," 0%,\n    "," 100%\n  );\n  z-index: ",";\n"]);return Ee=function(){return e},e}function ke(){var e=de()(["\n  padding-top: 56.25%;\n  width: 100%;\n  position: relative;\n"]);return ke=function(){return e},e}function Re(){var e=de()(["\n  width: ",";\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n"]);return Re=function(){return e},e}function Ce(){var e=de()(["\n  width: 100%;\n  height: 100%;\n  padding: ",";\n  display: flex;\n  position: relative;\n\n  &&&& {\n    ."," {\n      .","-playbackrate {\n        display: ",";\n      }\n    }\n  }\n"]);return Ce=function(){return e},e}function Pe(){var e=de()(["\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  flex: 1;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: ",";\n"]);return Pe=function(){return e},e}function Me(){var e=de()(["\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  max-height: calc(100vh - 160px);\n  top: 50%;\n  transform: translateY(-50%);\n  border-radius: 4px;\n\n  ."," {\n    width: 100% !important;\n    height: 100% !important;\n  }\n"]);return Me=function(){return e},e}function Se(){var e=de()(["\n  padding-top: 56.25%;\n  width: 100%;\n  position: relative;\n"]);return Se=function(){return e},e}function Ie(){var e=de()(["\n  width: 100%;\n  height: 100%;\n  padding: ",";\n  display: flex;\n  flex-direction: column;\n  position: relative;\n  justify-content: center;\n  align-items: center;\n\n  &&&& {\n    ."," {\n      .","-controls {\n        display: block !important;\n      }\n      .","-volume {\n        margin-right: 20px;\n      }\n      .","-poster {\n        background-color: transparent;\n      }\n    }\n\n    .","-pause:after, .","-nostart:after {\n      display: none;\n    }\n  }\n"]);return Ie=function(){return e},e}function Oe(){var e=de()(["\n  // 禁用浏览器原生样式\n  video::-webkit-media-controls {\n    display: none !important;\n    -webkit-appearance: none;\n  }\n\n  // 适配锤子手机\n  video::-webkit-media-controls-smartisan {\n    display: none !important;\n    -webkit-appearance: none;\n  }\n"]);return Oe=function(){return e},e}var _e="xgplayer",Ve=Object(pe.css)(Oe()),De=pe.default.div(Ie(),function(e){return e.isMobile?"0":"48px"},_e,_e,_e,_e,_e,_e),Ae=pe.default.div(Se()),Fe=pe.default.div(Me(),_e),Ue=pe.default.div(Pe(),F.a),Le=pe.default.div(Ce(),function(e){return e.isMobile?"0":"48px"},_e,_e,function(e){return e.isMobile&&"none"}),Ne=pe.default.div(Re(),function(e){return e.isMobile?"100%":"calc(100% - 96px)"}),je=pe.default.div(ke()),Be=pe.default.div(Ee(),function(e){return e.show?"block":"none"},fe.N00,Object(F.n)(fe.N1000,.5),Object(F.n)(fe.N1000,1e-4),F.l),We=pe.default.div(xe(),Be,function(e){return e.isMobile&&Ve}),He=pe.default.div(be(),fe.N00,Object(F.n)(fe.N700,.8),F.z),ze=pe.default.div(Te()),Ge=pe.default.span(we()),Ye=pe.default.span(ge()),Ke=pe.default.div(ye()),Xe=pe.default.div(me(),fe.N1000),Je=pe.default.span(ve(),fe.N00);function qe(){var e=de()(["\n  padding: 2px 6px;\n  min-width: 80px;\n  font-size: 12px;\n  user-select: none;\n  &:hover {\n    background: ",";\n  }\n"]);return qe=function(){return e},e}function Ze(){var e=de()(["\n  position: fixed;\n  top: ",";\n  left: ",";\n  background: ",";\n  color: ",";\n  padding: 4px 0;\n  list-style: none;\n  z-index: ",";\n"]);return Ze=function(){return e},e}var Qe=pe.default.ul(Ze(),function(e){return"".concat(e.top,"px")},function(e){return"".concat(e.left,"px")},Object(F.n)(fe.N800,.8),fe.N00,F.A),$e=pe.default.li(qe(),Object(F.n)(fe.N600,.8)),et="box-preview-context-menu",tt=function(e){function n(){var t;return C()(this,n),(t=I()(this,_()(n).apply(this,arguments))).wrapperRef=null,t.hideContextMenu=function(e){t.wrapperRef&&e.target&&t.wrapperRef.contains(e.target)||t.props.hideContextMenu()},t.setWrapperRef=function(e){return t.wrapperRef=e},t}return D()(n,e),M()(n,[{key:"componentDidMount",value:function(){document.body.addEventListener("click",this.hideContextMenu,!1)}},{key:"componentWillUnmount",value:function(){document.body.removeEventListener("click",this.hideContextMenu,!1)}},{key:"render",value:function(){var e=this.props,t=e.menuItems,n=e.top,r=e.left;return g.a.createElement(Qe,{"data-sel":et,top:n,left:r,innerRef:this.setWrapperRef},J()(t).call(t,function(e,t){return g.a.createElement($e,{key:t,onClick:e.clickHandle},e.text)}))}}]),n}(g.a.PureComponent),nt=1e3,rt=function(){function r(e,t,n){var o=this;C()(this,r),this.diffSize=0,this.diffTime=0,this.slidingWindow=[],this.speedTimer=null,this.pSpeed=0,this.currentBufferedPoint={start:0,end:0},this.currentTriggerTimestamp=0,this.videoInfo={fileSize:1,duration:1},this.calculate=function(){o.write();var e,t=o.slidingWindow.length;if(0===t)e=0;else{for(var n=0,r=0,i=0;i<t;i++)n+=o.slidingWindow[i],0<o.slidingWindow[i]&&(r+=1);e=0===r?0:n/r}o.speed=e},this.videoInfo=e,this.windowSize=t,this.onSpeedChanged=n}return M()(r,[{key:"updateTransferredBytes",value:function(e){var t,n,r,i=e.bufferedPoint;"number"==typeof i.start&&"number"==typeof i.end&&(t=z()(),this.currentTriggerTimestamp&&(n=(i.start===this.currentBufferedPoint.start?Math.max(0,i.end-this.currentBufferedPoint.end):Math.max(0,i.end-i.start))/this.videoInfo.duration*this.videoInfo.fileSize,r=t-this.currentTriggerTimestamp,this.add(Math.max(0,n),r)),this.currentBufferedPoint=i,this.currentTriggerTimestamp=t)}},{key:"updateVideoInfo",value:function(e){this.videoInfo=e}},{key:"clear",value:function(){this.speedTimer&&(window.clearInterval(this.speedTimer),this.speedTimer=null),this.diffSize=0,this.diffTime=0,this.slidingWindow=[],this.speed=0,this.currentTriggerTimestamp=0,this.currentBufferedPoint={start:0,end:0}}},{key:"add",value:function(e,t){this.speedTimer||(this.speedTimer=window.setInterval(this.calculate,nt)),this.diffSize+=e,this.diffTime+=t}},{key:"write",value:function(){var e=this.diffSize&&this.diffTime?Math.round(this.diffSize/this.diffTime*1e3):0;this.diffSize=0,this.diffTime=0,this.slidingWindow.push(e),this.slidingWindow.length>this.windowSize&&this.slidingWindow.shift()}},{key:"speed",set:function(e){this.pSpeed!==e&&(this.onSpeedChanged(e),this.pSpeed=e)}}]),r}();function it(t,e){var n,r=x()(t);return T.a&&(n=T()(t),e&&(n=m()(n).call(n,function(e){return h()(t,e).enumerable})),r.push.apply(r,n)),r}function ot(t){for(var e=1;e<arguments.length;e++){var n,r,i=null!=arguments[e]?arguments[e]:{};e%2?p()(n=it(Object(i),!0)).call(n,function(e){k()(t,e,i[e])}):u.a?l()(t,u()(i)):p()(r=it(Object(i))).call(r,function(e){a()(t,e,h()(i,e))})}return t}var at="box-preview-video",st="box-preview-audio",lt=["inner-controls","xgplayer-error"],ct="null",ut=1,dt=3,pt={NETWORK_ERROR:1,STREAM_TYPE_ERROR:2,PARSE_ERROR:3,FORMAT_ERROR:4,DECODE_ERROR:5,RUNTIME_ERROR:6,TIMEOUT_ERROR:7,OTHER:8},ft=function(e){function t(){var i;return C()(this,t),(i=I()(this,_()(t).apply(this,arguments))).fileToken=i.context.fileToken,i.currentTime=0,i.initProgressTime=0,i.videoBoxRef=void 0,i.audioBoxRef=void 0,i.innerPlayerRef=void 0,i.fullscreenWatermarkRef=null,i.definitionHasChanged=!1,i.canPlay=!1,i.hasPlayed=!1,i.firstPlayTimestamp=0,i.fileSizeMap=new ae.a,i.videoDimensionsMap=new ae.a,i.errorHandled=!1,i.state={contextMenuShown:!1,contextMenuTop:0,contextMenuLeft:0,videoInfoShown:!1,codecTag:"",errorCode:null,videoHeaderVisible:!0,containerMounted:!1,shouldShowUnsupportedVideoTips:!1,loadSpeed:0,videoDimensions:""},i.lastVCFollowTime=0,i.rememberCurrentProgressTime=function(){var e,t=i.props.enableMediaProgressCache,n=i.context.dataVersion;t&&(e=Boolean(!i.player||i.player.ended)?0:i.currentTime,Object(ce.b)({key:ie.K,info:{token:i.fileToken,version:n,time:e}}))},i.renderVideoXgPlayer=function(){return i.state.containerMounted?g.a.createElement(he.a,y()({},i.videoConfig,{onPlayerReady:i.onPlayerReady,i18nText:i.i18nText,coverLoadFailed:i.context.coverLoadFailed})):null},i.renderAudioXgPlayer=function(){return i.state.containerMounted?g.a.createElement(he.a,y()({},i.audioConfig,{onPlayerReady:i.onPlayerReady})):null},i.onPlayerReady=function(e,t){var n;e&&(n=i.props.mediaType,i.player=e,i.innerPlayerRef=t,i.resolutionConfig&&0<i.resolutionConfig.length&&i.player.emit("resourceReady",i.resolutionConfig),i.player.start(),n===ie.e.VIDEO&&(i.handleFullscreen(),i.context.isMobile&&i.tryOpenVideoControls()),i.setPlayerActionCallback())},i.handleEventByAction=function(e){if(e&&e.action)switch(e.action){case ie.y.MEDIA_PLAY:i.triggerMediaPlay();break;case ie.y.MEDIA_PAUSE:i.triggerMediaPause();break;case ie.y.MEDIA_SET_CURRENT_TIME:var t=e&&Object(q.default)(e.time)&&!isNaN(e.time)?e.time:0;i.setCurrentTime(t);break;case ie.y.MEDIA_SET_CURRENT_VOLUME:e&&Object(q.default)(e.volume)&&!isNaN(e.volume)&&i.setVolume(e.volume);break;default:console.error("Unhandled event action",e.action)}},i.triggerMediaPlay=function(){i.player&&i.player.play()},i.triggerMediaPause=function(){i.player&&i.player.pause()},i.setCurrentTime=function(e){i.player&&(i.player.currentTime=e)},i.setVolume=function(e){i.player&&(i.player.volume=e)},i.onSpeedChanged=function(e){i.setState({loadSpeed:e})},i.handlePlayerEnded=function(){i.setVideoHeaderVisible(!1),i.postFollowState()},i.logMediaPlayCostTime=function(e){i.context.eventBus.safelyEmit(re.b.MEDIA_PLAY_COST_TIME,{costTime:e})},i.handleMediaDataLoaded=function(){i.definitionHasChanged||(i.canPlay=!0,0<i.firstPlayTimestamp&&i.logMediaPlayCostTime(z()()-i.firstPlayTimestamp),i.props.enableMediaProgressCache&&i.initProgressTime&&(i.setCurrentTime(i.initProgressTime),i.lastVCFollowTime=i.initProgressTime),i.context.eventBus&&(i.context.eventBus.safelyEmit(re.b.MEDIA_CAN_PLAY),i.context.eventBus.safelyEmit(re.b.RESOURCE_LOADED)))},i.handleFullscreen=function(){i.player.on("fullscreen_change",i.handleFullscreenChange)},i.handleFullscreenChange=function(e){e&&i.innerPlayerRef&&i.fullscreenWatermarkRef&&(i.fullscreenWatermarkRef.style.display="block",i.innerPlayerRef.contains(i.fullscreenWatermarkRef)||i.innerPlayerRef.appendChild(i.fullscreenWatermarkRef)),!e&&i.fullscreenWatermarkRef&&(i.fullscreenWatermarkRef.style.display="none"),i.context.eventBus.safelyEmit(re.b.OPERATION,{operationType:e?re.i.MEDIA_FULLSCREEN:re.i.MEDIA_EXIT_FULLSCREEN,source:ie.E.TOOLBAR}),i.postFollowState()},i.showVideoStats=function(){i.setState({videoInfoShown:!0,videoDimensions:i.getVideoOriginalDimensions()}),i.hideContextMenu(),i.setCodecTag()},i.handleVideoContextMenu=function(e){var t=e.target;t&&L()(lt).call(lt,t.className)&&i.showContextMenu(e)},i.showContextMenu=function(e){e.preventDefault(),i.setState({contextMenuShown:!0,contextMenuTop:e.clientY,contextMenuLeft:e.clientX})},i.hideContextMenu=function(){i.setState({contextMenuShown:!1})},i.hideVideoInfo=function(){i.setState({videoInfoShown:!1})},i.setFullscreenWatermarkRef=function(e){return i.fullscreenWatermarkRef=e},i.setVideoBoxRef=function(e){return i.videoBoxRef=e},i.setAudioBoxRef=function(e){return i.audioBoxRef=e},i.setVideoHeaderVisible=function(e){i.setState({videoHeaderVisible:e})},i.postFollowState=function(){i.context.isVCFollow&&i.player&&i.context.eventBus.safelyEmit(re.b.POST_VC_FOLLOW_STATE,{status:i.playerStatus,currentTime:i.player.currentTime,isFullscreen:i.player.fullscreen,playbackRate:i.player.playbackRate})},i.handleReceiveVCFollowState=function(e){var t,n,r;i.player&&(t=e.status,n=e.currentTime,r=e.playbackRate,t===le.b.PLAYING?!i.player.hasStart||i.player.ended||i.player.paused?(i.player.currentTime=n,i.player.play()):Math.abs(n-i.player.currentTime)>dt&&(i.player.currentTime=n):(t===le.b.PAUSED&&(i.player.currentTime=n),i.player.pause()),i.player.playbackRate!==r&&(i.player.playbackRate=r))},i}function n(){return r.apply(this,arguments)}var r,i,o,a;function s(){return i.apply(this,arguments)}function l(){return o.apply(this,arguments)}function c(){return a.apply(this,arguments)}return D()(t,e),M()(t,[{key:"componentDidMount",value:function(){(0,this.context.updateProgress)(100),this.readLastProgressTime(),this.handleEventFromBus(re.g.ON),window.addEventListener("beforeunload",this.rememberCurrentProgressTime),this.setState({containerMounted:!0}),this.checkUntranscodeVideoCodec()}},{key:"componentDidUpdate",value:function(e,t){e.previewContent||!this.props.previewContent||!this.state.errorCode&&this.hasPlayed||this.refreshVideo(),!t.videoInfoShown&&this.state.videoInfoShown?this.initVideoLoadSpeedCalculator():t.videoInfoShown&&!this.state.videoInfoShown&&this.clearVideoLoadSpeedCalculator()}},{key:"componentWillUnmount",value:function(){this.handleEventFromBus(re.g.OFF),this.player&&this.props.mediaType===ie.e.VIDEO&&this.player.off("fullscreen_change",this.handleFullscreenChange),window.removeEventListener("beforeunload",this.rememberCurrentProgressTime),this.rememberCurrentProgressTime(),this.clearVideoLoadSpeedCalculator()}},{key:"checkUntranscodeVideoCodec",value:(a=W()(j.a.mark(function e(){var t,n,r,i,o;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.props,n=t.getVideoCodecTag,r=t.fileInfo,i=t.unsupportedVideoCodec,t.mediaType!==ie.e.VIDEO)return e.abrupt("return");e.next=3;break;case 3:return e.t0=F.D,e.t1=r,e.next=7,n();case 7:e.t2=e.sent,e.t3=Object(F.C)(),e.t4=i,e.t5={fileInfo:e.t1,codecTag:e.t2,browserName:e.t3,cannotFallbackVideoCodec:e.t4},(0,e.t0)(e.t5)&&(L()(o=r.available_preview_type).call(o,re.m.VIDEO)?this.hideOriginOption():this.setState({shouldShowUnsupportedVideoTips:!0}));case 13:case"end":return e.stop()}},e,this)})),c)},{key:"hideOriginOption",value:function(){var e,t=this.props.previewContent&&this.props.previewContent.transcode_urls;t&&(e=this.getParsedTranscodeUrl(t,!0).resolutionConfig,this.player.emit("resourceReady",e))}},{key:"refreshVideo",value:function(){var e,t,n,r;this.player&&this.player.paused&&((e=this.props.previewContent&&this.props.previewContent.transcode_urls)&&(n=(t=this.getParsedTranscodeUrl(e)).resolutionConfig,r=t.defaultUrl,this.hasPlayed?this.player.src=r:this.player.start(r),this.player.emit("resourceReady",n),this.videoBoxRef&&this.videoBoxRef.classList.remove("xgplayer-is-error","xgplayer-isloading")))}},{key:"readLastProgressTime",value:function(){var e,t=this.props.enableMediaProgressCache,n=this.context.dataVersion;!t||(e=Object(ce.a)({dataVersion:n,key:ie.K,fileToken:this.fileToken}))&&e.time&&(this.initProgressTime=Number(e.time))}},{key:"getParsedTranscodeUrl",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=this.context,r=n.fileType,i=n.i18n,o=n.originalPreviewUrl,a=n.dataVersion,s=y()({},e);delete s["320p"],Object(F.F)(r)&&(s[i["video.original_file"]]=o),t&&delete s[i["video.original_file"]];var l=a?"&data_version=".concat(a):"",c=Object(Z.default)(s,function(e,t){return{name:t,url:e+l}}),u=s["720p"]||s["480p"]||s["360p"];return{resolutionConfig:c,defaultUrl:u+=l}}},{key:"tryOpenVideoControls",value:function(){var e;this.videoBoxRef&&this.shouldBrowserUseNativeControls&&((e=this.videoBoxRef.querySelector("video"))&&e.setAttribute("controls",""))}},{key:"handleEventFromBus",value:function(e){var t=this.context.eventBus;t&&(t[e](re.b.TRIGGER_MEDIA_ACTION,this.handleEventByAction),t[e](re.b.RECEIVE_VC_FOLLOW_STATE,this.handleReceiveVCFollowState))}},{key:"setPlayerActionCallback",value:function(){var e,i,o,t,a,s,l=this;this.player&&(e=this.props,i=e.stringifyMetaInfo,o=e.mediaType,t=this.context,a=t.eventBus,s=t.showNotPreviewableComponent,this.player.on("progress",function(){l.player&&l.player.bufferedPoint&&l.videoLoadSpeedCalculator&&l.state.videoInfoShown&&l.videoLoadSpeedCalculator.updateTransferredBytes({bufferedPoint:l.player.bufferedPoint})}),this.player.on("definition_change",function(){l.hideVideoInfo()}),this.player.once("before_definition_change",function(){l.player.autoplay=!0,l.definitionHasChanged=!0}),this.player.on("error",function(){var e,t,n,r;l.errorHandled||(t=(e=l.player.video.error).code,n=e.message,r=ee()({code:t,message:n,metaInfo:i}),a.safelyEmit(re.b.PREVIEW_ERROR,{messageDetail:r,previewComponent:re.n.VIDEO}),o===ie.e.AUDIO&&t===pt.FORMAT_ERROR&&s(re.j.MEDIA_TYPE_UNSUPPORTED),l.setState({errorCode:t}),l.errorHandled=!0)}),this.player.on("play",function(){l.hasPlayed||(l.firstPlayTimestamp=z()(),l.canPlay&&l.logMediaPlayCostTime(0),l.hasPlayed=!0),a.safelyEmit(re.b.OPERATION,{operationType:re.i.MEDIA_PLAY,source:ie.E.TOOLBAR}),l.postFollowState(),l.setVideoHeaderVisible(!1)}),this.player.on("pause",function(){a.safelyEmit(re.b.OPERATION,{operationType:re.i.MEDIA_PAUSE,source:ie.E.TOOLBAR}),l.postFollowState(),l.player.ended||l.setVideoHeaderVisible(!0)}),this.player.on("loadeddata",this.handleMediaDataLoaded),this.player.on("timeupdate",function(e){var t=e.player.currentTime;a.safelyEmit(re.b.MEDIA_TIME_UPDATED,{time:t}),l.currentTime=t,l.context.isVCFollow&&Math.abs(t-l.lastVCFollowTime)>ut&&(l.lastVCFollowTime=t,l.postFollowState())}),this.player.on("ended",this.handlePlayerEnded),this.player.on("ratechange",this.postFollowState))}},{key:"initVideoLoadSpeedCalculator",value:(o=W()(j.a.mark(function e(){var t,n,r,i;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getCurrentVideoFileSize();case 2:t=e.sent,n=this.player&&this.player.duration?this.player.duration:1,r={fileSize:t,duration:n},this.videoLoadSpeedCalculator?this.videoLoadSpeedCalculator.updateVideoInfo(r):(i=6,this.videoLoadSpeedCalculator=new rt(r,i,this.onSpeedChanged));case 6:case"end":return e.stop()}},e,this)})),l)},{key:"clearVideoLoadSpeedCalculator",value:function(){this.videoLoadSpeedCalculator&&this.videoLoadSpeedCalculator.clear()}},{key:"getCurrentVideoFileSize",value:(i=W()(j.a.mark(function e(){var t,n,r,i,o;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=this.player.video.src){e.next=4;break}throw new Error("url empty");case 4:if(this.fileSizeMap.get(t))return e.abrupt("return",this.fileSizeMap.get(t));e.next=6;break;case 6:return n=this.context.networkController,e.next=9,n.head(t,null,{ignoreInterceptors:!0});case 9:if(r=e.sent,i=Object(Q.default)(r,"headers.content-length"))return o=Number(i),this.fileSizeMap.set(t,o),e.abrupt("return",o);e.next=15;break;case 15:return e.abrupt("return",1);case 18:return e.prev=18,e.t0=e.catch(0),console.warn("get video file size error",e.t0),e.abrupt("return",1);case 22:case"end":return e.stop()}},e,this,[[0,18]])})),s)},{key:"setCodecTag",value:(r=W()(j.a.mark(function e(){var t;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state.codecTag){e.next=8;break}return e.next=3,this.props.getVideoCodecTag();case 3:if(e.t0=e.sent,e.t0){e.next=6;break}e.t0=ct;case 6:t=e.t0,this.setState({codecTag:t});case 8:case"end":return e.stop()}},e,this)})),n)},{key:"getVideoOriginalDimensions",value:function(){try{var e,t=this.player.video;if(!t)throw new Error("no video tag");var n=t.src;if(!n)throw new Error("url empty");if(this.videoDimensionsMap.get(n))return this.videoDimensionsMap.get(n);var r=K()(e="".concat(t.videoWidth,"x")).call(e,t.videoHeight);return this.videoDimensionsMap.set(n,r),r}catch(e){return console.warn("get video dimensions error",e),""}}},{key:"renderVideoInfo",value:function(){var e=this.state,t=e.codecTag,n=e.loadSpeed,r=e.videoDimensions;return g.a.createElement(He,null,g.a.createElement(ze,null,g.a.createElement(Ge,null,"Video Codecs"),g.a.createElement(Ye,null,t)),g.a.createElement(ze,null,g.a.createElement(Ge,null,"Dimensions"),g.a.createElement(Ye,null,r)),g.a.createElement(ze,null,g.a.createElement(Ge,null,"Connection Speed"),g.a.createElement(Ye,null,"".concat(Object(F.G)(n,0),"ps"))),g.a.createElement(Ke,{onClick:this.hideVideoInfo},"[x]"))}},{key:"render",value:function(){var e=this.props,t=e.mediaType,n=e.fileInfo,r=this.context,i=r.renderWatermark,o=r.isMobile,a=r.i18n,s=r.DriveIcon,l=r.DriveCircularIcon,c=this.state,u=c.contextMenuShown,d=c.contextMenuTop,p=c.contextMenuLeft,f=c.videoInfoShown,h=c.shouldShowUnsupportedVideoTips,v=n.name;switch(t){case ie.e.VIDEO:return g.a.createElement(Le,{"data-sel":at,isMobile:o},g.a.createElement(Ne,{"data-sel":"".concat(at,"-wrapper"),onContextMenu:this.handleVideoContextMenu,isMobile:o},g.a.createElement(je,{"data-sel":"".concat(at,"-aspect-container")},g.a.createElement(We,{"data-sel":"".concat(at,"-container"),isMobile:o},h?g.a.createElement(Xe,{"data-sel":"".concat(at,"-error"),onContextMenu:this.showContextMenu},g.a.createElement(Je,{"data-sel":"".concat(at,"-error-text")},a["video.not_supported"])):g.a.createElement(g.a.Fragment,null,g.a.createElement("div",{ref:this.setVideoBoxRef,"data-sel":"".concat(at,"-content"),style:{width:"100%",height:"100%"}}),this.renderVideoXgPlayer(),g.a.createElement(Be,{"data-sel":"".concat(at,"-header"),show:this.shouldShowVideoInfoHeader},v)),f&&this.renderVideoInfo()))),i&&g.a.createElement("div",{ref:this.setFullscreenWatermarkRef,style:{display:"none"}},i()),u&&g.a.createElement(tt,{menuItems:this.videoContextMenu,hideContextMenu:this.hideContextMenu,top:d,left:p}));case ie.e.AUDIO:var m={"data-sel":"".concat(st,"-placeholder-icon"),"file-name":v,width:80,height:80};return g.a.createElement(De,{"data-sel":st,isMobile:o},g.a.createElement(Ae,{"data-sel":"".concat(st,"-aspect-container")},g.a.createElement(Fe,{"data-sel":"".concat(st,"-player-container")},g.a.createElement(Ue,{"data-sel":"".concat(st,"-placeholder")},o?l&&g.a.createElement(l,y()({},m)):g.a.createElement(s,y()({},m))),g.a.createElement("div",{ref:this.setAudioBoxRef,"data-sel":"".concat(st,"-content"),style:{width:"100%",height:"100%"}}),this.renderAudioXgPlayer())))}}},{key:"ignores",get:function(){var e=["backward","cover","forward","meta","next","prev"];return this.context.isMobile&&e.push("volume","definition","mobile"),this.context.isVCFollow&&e.push("fullscreen"),e}},{key:"commonPlayerConfig",get:function(){return{controls:{mode:"normal"},videoAttrbutes:{preload:this.props.disableMediaPreload?"none":void 0},width:void 0,height:void 0}}},{key:"mediaLanguageType",get:function(){switch(this.context.languageType){case"zh":return"zh-cn";case"ja":return"jp";default:return"en"}}},{key:"videoConfig",get:function(){var e,t=this.props,n=t.previewContent,r=t.previewUrl,i=this.context,o=i.coverImg,a=i.isMobile,s=n&&n.transcode_urls;s&&(e=this.getParsedTranscodeUrl(s).defaultUrl);var l=a?[]:[.5,.75,1,1.5,2],c=o?o.src:"";return ot({},this.commonPlayerConfig,{poster:c,playbackRate:l,ignores:this.ignores,width:void 0,height:void 0,mountElement:this.videoBoxRef,url:e||r||"",lang:this.mediaLanguageType})}},{key:"resolutionConfig",get:function(){var e,t=this.props.previewContent,n=t&&t.transcode_urls;return n&&(e=this.getParsedTranscodeUrl(n).resolutionConfig),e}},{key:"i18nText",get:function(){var e=this.context.i18n;return{HAVE_NOTHING:e["video.have_nothing"],HAVE_METADATA:e["video.have_meta_data"],HAVE_CURRENT_DATA:e["video.have_current_data"],HAVE_FUTURE_DATA:e["video.have_future_data"],HAVE_ENOUGH_DATA:e["video.have_enough_data"],NETWORK_EMPTY:e["video.network.empty"],NETWORK_IDLE:e["video.network.idle"],NETWORK_LOADING:e["video.network.loading"],NETWORK_NO_SOURCE:e["video.network.no_source"],MEDIA_ERR_ABORTED:e["video.aborted_error"],MEDIA_ERR_NETWORK:e["video.network_error"],MEDIA_ERR_DECODE:e["video.decode_error"],MEDIA_ERR_SRC_NOT_SUPPORTED:e["video.not_supported"],REPLAY:e["video.replay"],ERROR:e["video.error"]}}},{key:"shouldBrowserUseNativeControls",get:function(){return Object(F.H)()}},{key:"audioConfig",get:function(){var e,t=this.props,n=t.previewUrl,r=t.mediaType;return ot({},this.commonPlayerConfig,{mediaType:r,ignores:K()(e=[]).call(e,ne()(this.ignores),["fullscreen","playbackrate","start","miniScreen","makeBullet","textTrack","loading","mobile","pc","loading"]),url:[{src:n||"",name:this.fileToken,vid:"vid".concat(this.fileToken)}],videoConfig:{mediaType:"audio"},mountElement:this.audioBoxRef,lang:this.mediaLanguageType})}},{key:"videoContextMenu",get:function(){return[{text:this.context.i18n["video.stats"],clickHandle:this.showVideoStats}]}},{key:"playerStatus",get:function(){return this.player&&this.player.hasStart?this.player.ended?le.b.ENDED:this.player.paused?le.b.PAUSED:le.b.PLAYING:le.b.NOT_STARTED}},{key:"shouldShowVideoInfoHeader",get:function(){return!this.context.isMobile&&this.state.videoHeaderVisible}}]),t}(i.PureComponent);function ht(t,e){var n,r=x()(t);return T.a&&(n=T()(t),e&&(n=m()(n).call(n,function(e){return h()(t,e).enumerable})),r.push.apply(r,n)),r}function vt(t){for(var e=1;e<arguments.length;e++){var n,r,i=null!=arguments[e]?arguments[e]:{};e%2?p()(n=ht(Object(i),!0)).call(n,function(e){k()(t,e,i[e])}):u.a?l()(t,u()(i)):p()(r=ht(Object(i))).call(r,function(e){a()(t,e,h()(i,e))})}return t}ft.contextType=F.I;var mt=function(e){function n(e,t){var b;return C()(this,n),(b=I()(this,_()(n).call(this,e))).cancelGettingPreviewUrl=null,b.isMessageRegistered=!1,b.hasHandleUntranscodedCase=!1,b.previewType=null,b.pollCount=0,b.state={previewInfo:null,videoMetaInfo:""},b.clearTimeouts=function(){b.retryTimer&&clearTimeout(b.retryTimer)},b.getTranscodedPreviewData=function(){var t=W()(j.a.mark(function e(t){var n,r,i,o,a,s,l,c,u,d,p,f,h,v,m,y,g,w,T;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=b.context,r=n.networkController,i=n.showNotPreviewableComponent,o=n.commonParams,a=n.handlePreviewInfoGot,s=n.fileType,l=n.eventBus,c=n.setCustomLoadingComponent,u=n.fileInfo,e.prev=1,b.isTranscodedVideoResourceGot)return e.abrupt("return");e.next=4;break;case 4:if(b.pollCount>ie.V)return b.stopFetchingStatus(),e.abrupt("return");e.next=7;break;case 7:if(b.pollCount+=1,d=b.previewType,f=Object(Q.default)(u,"preview_meta.data.".concat(d)),!t||!f){e.next=14;break}p=f,e.next=17;break;case 14:return e.next=16,r.getPreviewUrl(vt({},o,{previewType:d}),{cancelToken:new F.c(function(e){return b.cancelGettingPreviewUrl=e})});case 16:p=e.sent;case 17:if(b.cancelGettingPreviewUrl=null,a({previewInfo:p,previewType:d}),h=p.status,v=p.preview_url,m=p.content,y=p.interval,g=void 0===y?ie.G:y,h===re.j.READY&&(v||m))return b.setState({previewInfo:p}),b.stopFetchingStatus(),e.abrupt("return");e.next=24;break;case 24:if(h===re.j.PROGRESS?(b.handlePreviewMsgRegister(),w=Math.max(ie.N,g),b.retryTimer=window.setTimeout(b.getTranscodedPreviewData,w)):b.stopFetchingStatus(),b.hasHandleUntranscodedCase)return e.abrupt("return");e.next=27;break;case 27:Object(F.F)(s)?b.useFallbackUrl():h===re.j.PROGRESS?(l.safelyEmit(re.b.FIRST_MEANINGFUL_PAINTED),c(b.renderTranscodingComponent)):i(h),b.hasHandleUntranscodedCase=!0,e.next=42;break;case 31:if(e.prev=31,e.t0=e.catch(1),r.isCancelError(e.t0))return e.abrupt("return");e.next=35;break;case 35:if(console.error("preview/get error occured",e.t0),b.stopFetchingStatus(),Object(F.F)(s))return b.useFallbackUrl(),e.abrupt("return");e.next=40;break;case 40:T=Object(F.E)(e.t0),i(re.j.INTERFACE_ERROR,T);case 42:case"end":return e.stop()}},e,null,[[1,31]])}));return function(e){return t.apply(this,arguments)}}(),b.renderTranscodingComponent=function(){return b.context.renderNotPreviewableComponent(re.j.PROGRESS,!0)},b.handlePreviewMsgRegister=function(){var e=b.props.PreviewMessageHandler;e&&e.register&&!b.isMessageRegistered&&(b.isMessageRegistered=!0,e.register(b.fileToken,b.handlePreviewMessageReceived))},b.handlePreviewMsgDeregister=function(){var e=b.props.PreviewMessageHandler;e&&e.deregister&&b.isMessageRegistered&&(e.deregister(b.fileToken,b.handlePreviewMessageReceived),b.isMessageRegistered=!1)},b.handlePreviewMessageReceived=function(e){var t,n,r,i,o,a;b.isTranscodedVideoResourceGot||(t=Object(F.w)(e))&&t.body&&(n=t.data_version,i=(r=t.body).preview_type,o=r.status,a=b.context.dataVersion,i===b.previewType&&n===a&&o===re.j.READY&&b.getTranscodedPreviewData())},b.getVideoCodecTag=W()(j.a.mark(function e(){var t,n,r,i,o,a,s,l,c;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t="null",b.context.isDriveSDK)return e.abrupt("return",t);e.next=3;break;case 3:if(e.prev=3,!b.state.videoMetaInfo){e.next=10;break}if((n=Object(F.w)(b.state.videoMetaInfo))&&n.meta_info)return r=Object(F.J)(n.meta_info),e.abrupt("return",r||t);e.next=9;break;case 9:return e.abrupt("return",t);case 10:return i=b.context,o=i.networkController,a=i.commonParams,e.next=13,o.getPreviewUrl(vt({},a,{previewType:re.m.VIDEO_META}));case 13:if((s=e.sent)&&s.extra)return l=Object(F.w)(s.extra),c=Object(F.J)(l.meta_info),e.abrupt("return",c||t);e.next=18;break;case 18:return e.abrupt("return",t);case 21:return e.prev=21,e.t0=e.catch(3),console.error("preview/get error",e.t0),e.abrupt("return",t);case 25:case"end":return e.stop()}},e,null,[[3,21]])})),b.previewType=Object(se.k)(t.fileInfo),b.fileToken=t.fileToken,b}return D()(n,e),M()(n,[{key:"componentDidMount",value:function(){Object(q.default)(this.previewType)?this.getTranscodedPreviewData(!0):this.useFallbackUrl(),this.setMetaInfoByFileInfo()}},{key:"componentDidUpdate",value:function(e,t){var n=this.state,r=n.previewInfo,i=n.videoMetaInfo,o=!t.previewInfo||t.previewInfo.status!==re.j.READY,a=r&&r.status===re.j.READY;o&&a&&this.context.logOpenFileStatus("success",ie.b.Success,{message_detail:i})}},{key:"componentWillUnmount",value:function(){this.cancelGettingPreviewUrl&&(this.cancelGettingPreviewUrl(),this.cancelGettingPreviewUrl=null),this.stopFetchingStatus()}},{key:"stopFetchingStatus",value:function(){this.clearTimeouts(),this.handlePreviewMsgDeregister()}},{key:"setMetaInfoByFileInfo",value:function(){var e=Object(Q.default)(this.context,"fileInfo.preview_meta.data.".concat(re.m.VIDEO_META,".extra"));e&&this.setState({videoMetaInfo:e})}},{key:"useFallbackUrl",value:function(){var e=this.context,t=e.originalPreviewUrl,n=e.handlePreviewInfoGot,r=Object(F.y)(t);this.setState({previewInfo:r}),n({previewInfo:r,previewType:re.m.ORIGIN_FILE})}},{key:"getIsTranscodedByPreviewInfo",value:function(e){return e&&e.status===re.j.READY&&e.content}},{key:"render",value:function(){var e=this.props,t=e.disableMediaPreload,n=e.enableMediaProgressCache,r=e.mediaType,i=e.unsupportedVideoCodec,o=this.state,a=o.previewInfo,s=o.videoMetaInfo;if(!a)return null;var l=a.preview_url,c=a.content;return g.a.createElement(ft,{mediaType:r,enableMediaProgressCache:n,fileInfo:this.context.fileInfo,previewContent:c,previewUrl:l,disableMediaPreload:t,stringifyMetaInfo:s,getVideoCodecTag:this.getVideoCodecTag,unsupportedVideoCodec:i})}},{key:"isTranscodedVideoResourceGot",get:function(){var e=this.state.previewInfo;return this.getIsTranscodedByPreviewInfo(e)}}]),n}(g.a.PureComponent);mt.contextType=F.I,t.default=mt}}]);
//# sourceMappingURL=box-preview-box-media.abdb386fcb0888a8ca14.js.map